rm(list=ls())
library(foreign)
library(survey)
natsal2 <- read.dta('~/Documents/M_Genitalium/Natsal-2 data/stata11/natsal_2000_for_archive.dta')
natsal2$newnocon <- natsal2$nonocon
table(natsal2$r1datef)
table(cut(natsal2$r1datef, breaks=c(-0.5, 1000))
)
table(cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000))
)
natsal2$r1datef_known <- factor(cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)), levels=c('no','yes','no'))
natsal2$r1datef_known <- factor(cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)), levels=c('n/a','yes','no'))
# make a new variable to try to get at no. new parters without a condom
natsal2$newnocon <- natsal2$nonocon
natsal2$r1datef_known <- factor(
cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)),
levels=c('n/a','yes','no')
)
table(natsal2$nonocon, natsal2$r1datef_known)
table(natsal2$nonocon, natsal2$r1datef_known, useNA='ifany')
# make a new variable to try to get at no. new parters without a condom
natsal2$newnocon <- natsal2$nonocon
natsal2$r1datef_known <- factor(
cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)),
labels=c('n/a','yes','no')
)
table(natsal2$nonocon, natsal2$r1datef_known, useNA='ifany')
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef_known <= 12 )] <-
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef_known <= 12 )] - 1
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef <= 12 )] <-
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef <= 12 )] - 1
table(natsal2$nonocon, natsal2$nonewcon)
table(natsal2$nonocon, natsal2$newnocon)
# make a new variable to try to get at no. new parters without a condom
natsal2$newnocon <- natsal2$nonocon
natsal2$r1datef_known <- factor(
cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)),
labels=c('n/a','yes','no')
)
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef <= 12 )] <-
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef <= 12 )] - 1
table(natsal2$c_result, natsal2$nonocon, natsal2$rsex, natsal2$agrp, useNA='ifany')
# make a new variable to try to get at no. new parters without a condom
natsal2$newnocon <- natsal2$nonocon
natsal2$r1datef_known <- factor(
cut(natsal2$r1datef, breaks=c(-1.5,-0.5, 1000, 10000)),
labels=c('n/a','yes','no')
)
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef > 12 )] <-
natsal2$newnocon[(natsal2$r1datef_known == 'yes') & (natsal2$r1datef > 12 )] - 1
table(natsal2$c_result, natsal2$nonocon, natsal2$rsex, natsal2$agrp, useNA='ifany')
table(natsal2$c_result, natsal2$newnocon, natsal2$rsex, natsal2$agrp, useNA='ifany')
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 10, 10))
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 10, 1))
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 10, 1))
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 10, 1))
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 10, 1))
qbeta(0.5, 1, 1)
qbeta(0.5, 10, 1)
qbeta(0.025, 10, 1)
qbeta(0.975, 10, 1)
qbeta(0.5, 1, 10)
plot(seq(0,1,0.01), dbeta(seq(0,1,0.01), 1, 10))
qbeta(0.025, 1, 10)
qbeta(0.975, 1, 10)
devtools::install_github("mrc-ide/odin", upgrade = FALSE)
lorenz <- odin::odin({
## Derivatives
deriv(y1) <- sigma * (y2 - y1)
deriv(y2) <- R * y1 - y2 - y1 * y3
deriv(y3) <- -b * y3 + y1 * y2
## Initial conditions
initial(y1) <- 10.0
initial(y2) <- 1.0
initial(y3) <- 1.0
## parameters
sigma <- 10.0
R     <- 28.0
b     <-  8.0 / 3.0
config(base) <- "lorenz"
}, path)
lorenz <- odin::odin({
## Derivatives
deriv(y1) <- sigma * (y2 - y1)
deriv(y2) <- R * y1 - y2 - y1 * y3
deriv(y3) <- -b * y3 + y1 * y2
## Initial conditions
initial(y1) <- 10.0
initial(y2) <- 1.0
initial(y3) <- 1.0
## parameters
sigma <- 10.0
R     <- 28.0
b     <-  8.0 / 3.0
config(base) <- "lorenz"
} )
lorenz
y <- lorenz$run(t)
y <- (lorenz())$run(t)
t
t <- seq(0, 10, length.out = 101)
t
y <- (lorenz())$run(t)
y
plot(y, xlab = "Time", ylab = "y", main = "", las = 1)
config(base) <- "model1"
config(base) <- "lorenz"
source('~/Documents/teaching_etc/StochPractical2018/odin_lorenz.R')
model1 <- odin::odin({
## Derivatives
deriv(N_ODE) <- r*N_ODE
## Initial conditions
initial(N_ODE) <- N0
## parameters
r <- 0.5 # Growth rate/week
N0 <- 5 #	Initial number
config(base) <- "model1"
} )
source('~/Documents/teaching_etc/StochPractical2018/model1_single_stochastic_growth.R')
source('~/Documents/teaching_etc/StochPractical2018/model1_single_stochastic_growth.R')
source('~/Documents/teaching_etc/StochPractical2018/model1_single_stochastic_growth.R')
N_ODE <- (model2())$run(t)
source('~/Documents/teaching_etc/StochPractical2018/model2_stochastic_growth.R')
source('~/Documents/teaching_etc/StochPractical2018/model2_stochastic_growth.R')
N_ODE <- (model3())$run(t)
source('~/Documents/teaching_etc/StochPractical2018/model3_stochastic_growth_and_death.R')
devtools::install_github("mrc-ide/odin", upgrade = FALSE)
vignette()
vignette(, package="odin")
setwd('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical')
gen <- odin::odin("odin/example3.R")
mod <- gen()
tt <- seq(0, 15)
nsim <- 1
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.1), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.1), lty = 1, lwd = 0.5, xlab = "time", ylab = "N", log='y')
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
nsim <- 1
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
yy
nsim <- 100
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
nsim
yy
nsim <- 10
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
yy
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.1), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
yy
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N", log='y')
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
nsim <- 1
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N", log='y')
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
yy
N_mean <- apply(N,2,mean)
N_mean <- apply(yy$N,2,mean)
nsim <- 10
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
lines(yy$t, yy$N[, 1], col = "red", lwd = 2)
N_mean <- apply(yy$N,2,mean)
N_mean
yy$N
N_mean <- apply(yy$N,1,mean)
N_mean
lines(yy$t, N_mean, col='blue', lwd=2)
yy$N >=1
# Estimate fade-out fraction across runs
fade <- apply(yy$N >=1, 1, mean)
fade_fraction = 100 - 100*apply(fade, 1, mean)
# Estimate fade-out fraction across runs
fade <- (yy$N >=1)
fade_fraction = 100 - 100*apply(fade, 1, mean)
fade_fraction
plot(yy$t, fade_fraction)
plot(yy$t, fade_fraction, type='l')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
yy
ls(N)
ls(yy)
gen <- odin::odin("odin/example3.R")
mod <- gen()
tt <- seq(0, 15)
# multiple runs
nsim <- 100
yy <- mod$transform_variables(mod$run(tt, replicate = nsim))
ls(yy)
matplot(yy$t, yy$N, type = "l", col = rgb(0,0,0,0.5), lty = 1, lwd = 0.5, xlab = "time", ylab = "N")
lines(yy$t, yy$N_det[, 1], col = "red", lwd = 2)
# Estimate average N across runs
N_mean <- apply(yy$N,1,mean)
lines(yy$t, N_mean, col='blue', lwd=2)
# add legend
legend('topleft', col=c('red', 'blue'), lwd=2, legend=c('Deterministic solution', 'Mean of simulations'))
# Estimate fade-out fraction across runs
fade <- (yy$N >=1)
fade_fraction = 100 - 100*apply(fade, 1, mean)
plot(yy$t, fade_fraction, type='l')
plot(yy$t, fade_fraction, type='l', xlab='time', ylab='Fraction faded out')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
source('~/Documents/teaching_etc/StochPractical2018/stochasticity-practical/odin/example3_use.R')
